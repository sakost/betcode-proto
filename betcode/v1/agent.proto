// BetCode Agent Service
// Primary service for AI agent interaction with bidirectional streaming.
//
// Version: v1
// See: docs/architecture/PROTOCOL_L2.md

syntax = "proto3";

package betcode.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "betcode/v1/common.proto";
import "betcode/v1/tunnel.proto";

// AgentService provides the primary interface for AI agent interaction.
service AgentService {
  // Bidirectional streaming conversation with Claude.
  rpc Converse(stream AgentRequest) returns (stream AgentEvent);

  // List all sessions, optionally filtered.
  rpc ListSessions(ListSessionsRequest) returns (ListSessionsResponse);

  // Resume a session and replay events from a sequence number.
  rpc ResumeSession(ResumeSessionRequest) returns (stream AgentEvent);

  // Trigger context compaction for a session.
  rpc CompactSession(CompactSessionRequest) returns (CompactSessionResponse);

  // Cancel the current turn in a session.
  rpc CancelTurn(CancelTurnRequest) returns (CancelTurnResponse);

  // Request exclusive input lock for a session.
  rpc RequestInputLock(InputLockRequest) returns (InputLockResponse);

  // Exchange ephemeral keys for E2E encryption with a daemon.
  rpc ExchangeKeys(KeyExchangeRequest) returns (KeyExchangeResponse);
}

// =============================================================================
// Client -> Agent Messages
// =============================================================================

// AgentRequest wraps all client-to-agent message types.
message AgentRequest {
  oneof request {
    StartConversation start = 1;
    UserMessage message = 2;
    PermissionResponse permission = 3;
    UserQuestionResponse question_response = 4;
    CancelRequest cancel = 5;
    EncryptedEnvelope encrypted = 6;
  }
}

// StartConversation initiates or resumes a conversation session.
message StartConversation {
  string session_id = 1;
  string working_directory = 2;
  string model = 3;
  repeated string allowed_tools = 4;
  bool plan_mode = 5;
  string worktree_id = 6;
  map<string, string> metadata = 7;
}

// UserMessage contains the user's input.
message UserMessage {
  string content = 1;
  repeated Attachment attachments = 2;
}

// PermissionResponse is the user's decision on a permission request.
message PermissionResponse {
  string request_id = 1;
  PermissionDecision decision = 2;
  // Modified tool input (for ALLOW_WITH_EDIT).
  google.protobuf.Struct updated_input = 3;
  // Deny message or follow-up comment.
  string message = 4;
}

// UserQuestionResponse is the user's answer to a question.
message UserQuestionResponse {
  string question_id = 1;
  map<string, string> answers = 2;
}

// CancelRequest asks to cancel the current agent turn.
message CancelRequest {
  string reason = 1;
}

// =============================================================================
// Agent -> Client Events
// =============================================================================

// AgentEvent wraps all agent-to-client event types.
message AgentEvent {
  uint64 sequence = 1;
  google.protobuf.Timestamp timestamp = 2;
  string parent_tool_use_id = 3;

  oneof event {
    TextDelta text_delta = 10;
    ToolCallStart tool_call_start = 11;
    ToolCallResult tool_call_result = 12;
    PermissionRequest permission_request = 13;
    UserQuestion user_question = 14;
    TodoUpdate todo_update = 15;
    StatusChange status_change = 16;
    SessionInfo session_info = 17;
    ErrorEvent error = 18;
    UsageReport usage = 19;
    PlanModeChange plan_mode = 20;
    TurnComplete turn_complete = 21;
    UserInput user_input = 22;
    EncryptedEnvelope encrypted = 23;
  }
}

// TextDelta streams incremental text output.
message TextDelta {
  string text = 1;
  bool is_complete = 2;
}

// ToolCallStart indicates Claude is invoking a tool.
message ToolCallStart {
  string tool_id = 1;
  string tool_name = 2;
  google.protobuf.Struct input = 3;
  string description = 4;
}

// ToolCallResult contains tool output.
message ToolCallResult {
  string tool_id = 1;
  string output = 2;
  bool is_error = 3;
  uint32 duration_ms = 4;
}

// PermissionRequest asks the user to approve a tool call.
message PermissionRequest {
  string request_id = 1;
  string tool_name = 2;
  string description = 3;
  google.protobuf.Struct input = 4;
}

// UserQuestion presents a question from Claude.
message UserQuestion {
  string question_id = 1;
  string question = 2;
  repeated QuestionOption options = 3;
  bool multi_select = 4;
}

// TodoUpdate provides the current task list state.
message TodoUpdate {
  repeated TodoItem items = 1;
}

// StatusChange indicates a change in agent state.
message StatusChange {
  AgentStatus status = 1;
  string message = 2;
}

// SessionInfo provides metadata about the session.
message SessionInfo {
  string session_id = 1;
  string model = 2;
  string working_directory = 3;
  string worktree_id = 4;
  uint64 message_count = 5;
  bool is_resumed = 6;
  bool is_compacted = 7;
  float context_usage_percent = 8;
}

// ErrorEvent indicates an error occurred.
message ErrorEvent {
  string code = 1;
  string message = 2;
  bool is_fatal = 3;
  map<string, string> details = 4;
}

// UsageReport provides token usage and cost.
message UsageReport {
  uint32 input_tokens = 1;
  uint32 output_tokens = 2;
  uint32 cache_read_tokens = 3;
  uint32 cache_creation_tokens = 4;
  string model = 5;
  double cost_usd = 6;
  uint32 duration_ms = 7;
}

// PlanModeChange indicates plan mode toggled.
message PlanModeChange {
  bool active = 1;
  string plan = 2;
}

// TurnComplete indicates the agent finished a turn.
message TurnComplete {
  string stop_reason = 1;
}

// UserInput records a user's prompt for session replay.
message UserInput {
  string content = 1;
}

// EncryptedEnvelope wraps an application-layer encrypted payload.
// The relay sees valid protobuf but cannot read the inner content.
message EncryptedEnvelope {
  bytes ciphertext = 1;
  bytes nonce = 2;
}

// =============================================================================
// Session Management
// =============================================================================

message ListSessionsRequest {
  string working_directory = 1;
  string worktree_id = 2;
  uint32 limit = 3;
  uint32 offset = 4;
}

message ListSessionsResponse {
  repeated SessionSummary sessions = 1;
  uint32 total = 2;
}

message SessionSummary {
  string id = 1;
  string model = 2;
  string working_directory = 3;
  string worktree_id = 4;
  string status = 5;
  uint32 message_count = 6;
  uint32 total_input_tokens = 7;
  uint32 total_output_tokens = 8;
  double total_cost_usd = 9;
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
  string last_message_preview = 12;
}

message ResumeSessionRequest {
  string session_id = 1;
  uint64 from_sequence = 2;
}

message CompactSessionRequest {
  string session_id = 1;
}

message CompactSessionResponse {
  uint32 messages_before = 1;
  uint32 messages_after = 2;
  uint32 tokens_saved = 3;
}

message CancelTurnRequest {
  string session_id = 1;
}

message CancelTurnResponse {
  bool was_active = 1;
}

message InputLockRequest {
  string session_id = 1;
}

message InputLockResponse {
  bool granted = 1;
  string previous_holder = 2;
}
